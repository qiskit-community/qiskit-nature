# This code is part of Qiskit.
#
# (C) Copyright IBM 2022.
#
# This code is licensed under the Apache License, Version 2.0. You may
# obtain a copy of this license in the LICENSE.txt file in the root directory
# of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.
#
# Any modifications or derivative works of this code must retain this
# copyright notice, and modified files need to carry a notice indicating
# that they have been altered from the originals.

name: 'Install Qiskit Nature Main Terra'
description: 'Installs Python Main Terra'
inputs:
  cache-path:
    description: 'Cache path'
    required: true
  cache-hit:
    description: 'Cache hit'
    required: true
runs:
  using: "composite"
  steps:
    - name: Install Terra from Main
      env:
        MACOSX_DEPLOYMENT_TARGET: 10.9
      run: |
        source "$CONDA/etc/profile.d/conda.sh"
        conda activate psi4env
        BASE_DIR=${{ inputs.cache-path }}
        build_from_main=true
        if [ "${{ inputs.cache-hit }}" == "true" ]; then
          pip_result=0
          pushd "${BASE_DIR}"
          python -m pip install *.whl && pip_result=$? || pip_result=$?
          popd
          if [ $pip_result == 0 ]; then
            build_from_main=false
          fi
        else
          mkdir -p ${BASE_DIR}
        fi
        if [ "$build_from_main" == "true" ]; then
          echo 'Create wheel file from main'
          pip install -U setuptools_rust
          git clone https://github.com/Qiskit/qiskit-terra.git /tmp/qiskit-terra
          pushd /tmp/qiskit-terra
          python setup.py bdist_wheel
          popd
          cp -rf /tmp/qiskit-terra/dist/*.whl "${BASE_DIR}"
          pushd "${BASE_DIR}"
          python -m pip install *.whl
          popd
        fi
      shell: bash
